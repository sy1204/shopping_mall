# 챗봇 API 디버깅 로그

## 문제 발생일: 2026-01-10

## 증상
- 챗봇이 같은 말을 반복함
- 모든 응답이 `**`로 시작하는 가짜(fallback) 문구
- 에러 메시지: `(사용량 많음)` 표시

---

## 시도 및 결과

### 1. 문제 분석 ✅ 성공
**시도**: 브라우저에서 채팅 테스트 및 API 응답 분석
**결과**: 
- `**`로 시작하는 메시지는 Gemini API 실패 시 fallback 템플릿
- 에러 코드: `429 - You exceeded your current quota`
- Google AI Studio 대시보드에서 429 TooManyRequests 에러 대량 확인

**교훈**: API 응답에 디버그 정보를 포함시키면 원격 디버깅이 쉬워짐

---

### 2. 새 API 키 발급 ⚠️ 일부 성공
**시도**: 새 Google 계정으로 새 Gemini API 키 발급 및 Vercel 환경 변수 업데이트
**결과**: 
- 새 키도 즉시 429 에러 발생
- 새 계정 사용량: 3번 요청 중 2번 429 에러

**교훈**: 
- Vercel 환경 변수 변경 후 반드시 **재배포** 필요
- 무료 티어 분당 요청 제한(RPM)이 매우 낮음 (2-15 RPM)
- 각 채팅이 **2번의 API 호출** (임베딩 + 생성)을 사용하여 할당량을 빠르게 소진

---

### 3. 모델 변경 시도 ❌ 실패
**시도**: 
- `gemini-2.0-flash` → `gemini-1.5-flash` → `gemini-1.5-flash-latest` → `gemini-pro`

**결과**: 
- `gemini-2.0-flash`: 429 (존재하지만 rate limited)
- `gemini-1.5-flash`: 404 (모델 없음)
- `gemini-1.5-flash-latest`: 404 (모델 없음)
- `gemini-pro`: 404 (모델 없음)

**교훈**: 
- 무료 티어에서 사용 가능한 모델이 제한적
- `gemini-2.0-flash`만 유효 (2026년 1월 기준)
- 모델명 변경 전 API 문서 확인 필수

---

### 4. 재시도 로직 추가 ⚠️ 일부 성공
**시도**: 429 에러 시 지수 백오프(4초→8초→16초)로 최대 3회 재시도
**결과**: 
- Vercel 서버리스 함수 타임아웃(10초) 때문에 재시도 완료 전 실패
- 여전히 429 응답

**교훈**: 
- 서버리스 환경에서는 긴 대기 시간이 있는 재시도 로직이 비효율적
- Vercel 무료 티어 타임아웃: 10초

---

### 5. API 호출 50% 감소 ⚠️ 일부 성공
**시도**: 임베딩 API 호출 제거, 키워드 기반 DB 검색으로 대체
- 변경 전: 채팅 1번 = API 2번 호출 (임베딩 + 생성)
- 변경 후: 채팅 1번 = API 1번 호출 (생성만)

**결과**: API 호출 50% 감소했으나 여전히 429 발생

---

### 6. 응답 캐싱 추가 ⚠️ 일부 성공
**시도**: 성공적인 응답을 메모리 캐시에 저장 (5분 TTL)
- 동일한 질문에 대해 API 호출 없이 캐시된 응답 반환
- `**`로 시작하는 fallback 응답은 캐시하지 않음

**결과**: 캐싱 로직 구현 완료, 하지만 Gemini 429 에러로 인해 테스트 불가

---

### 7. OpenAI API로 전환 ✅ 성공
**시도**: Gemini API → OpenAI GPT-4o-mini로 완전 전환
- `OPENAI_API_KEY` 환경 변수 사용
- `gpt-4o-mini` 모델 사용 (비용 효율적)
- Gemini 관련 코드 완전 제거

**결과**: 
- ✅ 정상 작동! 더 이상 `**`로 시작하는 fallback 메시지 없음
- ✅ 개인화된 AI 답변 생성 성공
- ✅ 상품 추천 + 스타일링 팁 생성

---

## 핵심 교훈

1. **API 할당량 모니터링**: Google AI Studio 대시보드에서 사용량 및 에러 확인 가능
2. **디버그 정보 포함**: 프로덕션 응답에 에러 상세 정보를 포함하면 원격 디버깅 용이
3. **환경 변수 변경 = 재배포**: Vercel에서 환경 변수 변경 시 자동 재배포되지 않음
4. **무료 티어 제한 인식**: 
   - RPM (분당 요청 수): 2-15회
   - 여러 API 호출이 필요한 기능은 할당량을 빠르게 소진
5. **서버리스 타임아웃**: Vercel 무료 티어는 10초 타임아웃, 긴 재시도 로직 부적합

---

## 추후 개선 방향

1. **결제 플랜 업그레이드**: Gemini API 유료 플랜으로 RPM 제한 완화
2. **응답 캐싱**: 자주 묻는 질문에 대한 응답 캐싱
3. **대안 AI 서비스**: OpenAI, Anthropic 등 다른 AI 서비스 고려
4. **사용자당 요청 제한**: 프론트엔드에서 분당 요청 수 제한
